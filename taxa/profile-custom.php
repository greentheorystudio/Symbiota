<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa-description-block.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa-description-statement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa-map.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa-vernacular.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/checkboxInputElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/dateInputElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/selectorInputElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/textFieldInputElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileEditButton.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileScinameHeader.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileNotFound.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonNotes.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonFamily.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonVernaculars.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonIdentifiers.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonSynonyms.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileCentralmage.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileDescriptionTabs.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonMap.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonImageLink.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonOccurrenceLink.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileImagePanel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileSubtaxaPanel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileMediaPanel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/spatialBaseLayerSelector.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/spatial/spatialViewerElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/determinationRecordInfoBlock.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/geneticLinkRecordInfoBlock.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/media/imageCarousel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/media/imageRecordInfoBlock.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/media/mediaRecordInfoBlock.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/mofDataFieldRow.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/mofDataFieldRowGroup.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/occurrenceInfoTabModule.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/occurrenceInfoWindowPopup.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/media/mediaInfoWindowPopup.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileImageCarousel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/custom/wisTaxaProfileImagePanel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script type="text/javascript">
    const taxonProfilePage = Vue.createApp({
        template: `
            <template v-if="Number(taxon['tid']) > 0">
                <div class="row justify-between q-mt-sm">
                    <div class="column">
                        <taxa-profile-sciname-header></taxa-profile-sciname-header>
                        <taxa-profile-taxon-family></taxa-profile-taxon-family>
                        <taxa-profile-taxon-notes></taxa-profile-taxon-notes>
                        <taxa-profile-taxon-vernaculars></taxa-profile-taxon-vernaculars>
                        <taxa-profile-taxon-synonyms></taxa-profile-taxon-synonyms>
                    </div>
                    <template v-if="isTaxonEditor || isTaxonProfileEditor">
                        <taxa-profile-edit-button :taxon-editor="isTaxonEditor" :taxon-profile-editor="isTaxonProfileEditor"></taxa-profile-edit-button>
                    </template>
                </div>
                <div class="row justify-between q-mt-sm">
                    <div class="left-column column">
                        <taxa-profile-central-image :image="centralImage" :is-editor="isTaxonProfileEditor" @update:set-image-carousel="showImageCarousel"></taxa-profile-central-image>
                    </div>
                    <div class="right-column column">
                        <taxa-profile-description-tabs></taxa-profile-description-tabs>
                    </div>
                </div>
                <div class="row justify-between items-center q-mt-md">
                    <div>
                        <taxa-profile-taxon-occurrence-link></taxa-profile-taxon-occurrence-link>
                    </div>
                    <template v-if="taxon.imageCnt > 100">
                        <div>
                            <taxa-profile-taxon-image-link></taxa-profile-taxon-image-link>
                        </div>
                    </template>
                    <div>
                        <taxa-profile-taxon-map></taxa-profile-taxon-map>
                    </div>
                </div>
                <template v-if="Number(taxon.rankid) > 180 && fieldImageArr.length > 0">
                    <div class="q-mt-md profile-center-row">
                        <div class="expansion-container">
                            <q-card>
                                <div class="q-pt-sm q-pl-md q-mb-md text-h6 text-weight-bold image-sideways-scroller-label">
                                    Field Images
                                </div>
                                <q-scroll-area class="q-px-md img-sideways-scroller">
                                    <div class="row no-wrap q-gutter-md">
                                        <div v-for="image in fieldImageArr" :key="image" class="img-thumb q-mb-sm">
                                            <a @click="showFieldImageCarousel(image.url);" class="cursor-pointer">
                                                <q-img :src="image.url" fit="contain" height="240px" :title="image.caption" :alt="image.sciname"></q-img>
                                            </a>
                                            <div class="photographer">
                                                <a :href="(clientRoot + '/taxa/index.php?taxon=' + image.tid)">
                                                    <span>{{ image.photographer }}</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </q-scroll-area>
                            </q-card>
                        </div>
                    </div>
                </template>
                <template v-if="Number(taxon.rankid) > 180 && specimenImageArr.length > 0">
                    <div class="q-mt-md profile-center-row">
                        <div class="expansion-container">
                            <q-card>
                                <div class="q-pt-sm q-pl-md q-mb-md text-h6 text-weight-bold image-sideways-scroller-label">
                                    Specimen Images
                                </div>
                                <q-scroll-area class="q-px-md img-sideways-scroller">
                                    <div class="row no-wrap q-gutter-md">
                                        <div v-for="image in specimenImageArr" :key="image" class="img-thumb q-mb-sm">
                                            <a @click="showSpecimenImageCarousel(image.url);" class="cursor-pointer">
                                                <q-img :src="image.url" fit="contain" height="240px" :title="image.caption" :alt="image.sciname"></q-img>
                                            </a>
                                            <div class="photographer">
                                                <a :href="(clientRoot + '/collections/individual/index.php?occid=' + image.occid)" target="_blank">
                                                    <template v-if="image.catalognumber || image.othercatalognumbers">
                                                        {{ image.catalognumber ? image.catalognumber : '' }}{{ image.catalognumber && image.othercatalognumbers ? '/' : '' }}{{ image.othercatalognumbers ? image.othercatalognumbers : '' }}
                                                    </template>
                                                    <template v-else>
                                                        [See Full Record]
                                                    </template>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </q-scroll-area>
                            </q-card>
                        </div>
                    </div>
                </template>
                <div class="row justify-center q-mt-md">
                    <taxa-profile-subtaxa-panel :is-editor="isTaxonProfileEditor"></taxa-profile-subtaxa-panel>
                </div>
            </template>
            <template v-else>
                <taxa-profile-not-found></taxa-profile-not-found>
            </template>
            <template v-if="Number(taxon.rankid) > 180">
                <q-dialog v-model="fieldImageCarousel" persistent full-width full-height>
                    <taxa-profile-image-carousel :image-arr="fieldImageArr" :image-index="fieldImageCarouselSlide" @update:show-image-carousel="toggleFieldImageCarousel" @update:current-image="updateFieldImageCarousel"></taxa-profile-image-carousel>
                </q-dialog>
                <q-dialog v-model="specimenImageCarousel" persistent full-width full-height>
                    <taxa-profile-image-carousel :image-arr="specimenImageArr" :image-index="specimenImageCarouselSlide" @update:show-image-carousel="toggleSpecimenImageCarousel" @update:current-image="updateSpecimenImageCarousel"></taxa-profile-image-carousel>
                </q-dialog>
            </template>
        `,
        components: {
            'taxa-profile-edit-button': taxaProfileEditButton,
            'taxa-profile-sciname-header': taxaProfileScinameHeader,
            'taxa-profile-not-found': taxaProfileNotFound,
            'taxa-profile-taxon-notes': taxaProfileTaxonNotes,
            'taxa-profile-taxon-family': taxaProfileTaxonFamily,
            'taxa-profile-taxon-vernaculars': taxaProfileTaxonVernaculars,
            'taxa-profile-taxon-identifiers': taxaProfileTaxonIdentifiers,
            'taxa-profile-taxon-synonyms': taxaProfileTaxonSynonyms,
            'taxa-profile-central-image': taxaProfileCentralImage,
            'taxa-profile-description-tabs': taxaProfileDescriptionTabs,
            'taxa-profile-taxon-map': taxaProfileTaxonMap,
            'taxa-profile-taxon-image-link': taxaProfileTaxonImageLink,
            'taxa-profile-taxon-occurrence-link': taxaProfileTaxonOccurrenceLink,
            'taxa-profile-image-panel': taxaProfileImagePanel,
            'taxa-profile-subtaxa-panel': taxaProfileSubtaxaPanel,
            'taxa-profile-media-panel': taxaProfileMediaPanel,
            'taxa-profile-image-carousel': taxaProfileImageCarousel,
            'wis-taxa-profile-image-panel': wisTaxaProfileImagePanel
        },
        setup() {
            const { hideWorking, showWorking } = useCore();
            const baseStore = useBaseStore();
            const taxaStore = useTaxaStore();

            const centralImage = Vue.ref(null);
            const clientRoot = baseStore.getClientRoot;
            const fieldImageArr = Vue.ref([]);
            const fieldImageCarousel = Vue.ref(false);
            const fieldImageCarouselSlide = Vue.ref(null);
            const imageArr = Vue.ref([]);
            const imageCarousel = Vue.ref(false);
            const imageCarouselSlide = Vue.ref(null);
            const isTaxonEditor = Vue.ref(false);
            const isTaxonProfileEditor = Vue.ref(false);
            const specimenImageArr = Vue.ref([]);
            const specimenImageCarousel = Vue.ref(false);
            const specimenImageCarouselSlide = Vue.ref(null);
            const subtaxaArr = Vue.computed(() => taxaStore.getTaxaChildren);
            const taxaImageArr = Vue.computed(() => taxaStore.getTaxaImageArr);
            const taxaImageCount = Vue.computed(() => taxaStore.getTaxaImageCount);
            const taxon = Vue.computed(() => taxaStore.getAcceptedTaxonData);
            const taxonValue = TAXON_VAL;

            function processImages() {
                imageArr.value.forEach((image) => {
                    if(Number(image['occid']) > 0){
                        image['anchorUrl'] = clientRoot + '/collections/individual/index.php?occid=' + image['occid'];
                        if(image['basisofrecord'].includes('Observation')){
                            fieldImageArr.value.push(image);
                        }
                        else{
                            specimenImageArr.value.push(image);
                        }
                    }
                    else{
                        image['anchorUrl'] = clientRoot + '/imagelib/imgdetails.php?imgid=' + image['id'];
                        fieldImageArr.value.push(image);
                    }
                });
                if(fieldImageArr.value.length > 0){
                    centralImage.value = fieldImageArr.value[0];
                }
                else{
                    centralImage.value = specimenImageArr.value[0];
                }
            }

            function setEditor() {
                const formData = new FormData();
                formData.append('permissionJson', JSON.stringify(['TaxonProfile', 'Taxonomy']));
                formData.append('action', 'validatePermission');
                fetch(permissionApiUrl, {
                    method: 'POST',
                    body: formData
                })
                .then((response) => {
                    return response.ok ? response.json() : null;
                })
                .then((resData) => {
                    isTaxonEditor.value = resData.includes('Taxonomy');
                    isTaxonProfileEditor.value = resData.includes('TaxonProfile');
                });
            }

            function setTaxonFieldImages(limit) {
                const formData = new FormData();
                formData.append('tidArr', JSON.stringify([taxon.value['tid']]));
                formData.append('includeoccurrence', '0');
                formData.append('limitPerTaxon', limit);
                formData.append('action', 'getTaxonArrDisplayImageData');
                fetch(imageApiUrl, {
                    method: 'POST',
                    body: formData
                })
                .then((response) => {
                    return response.ok ? response.json() : null;
                })
                .then((resObj) => {
                    if(resObj.hasOwnProperty(taxon.value['tid'])){
                        imageArr.value = resObj[taxon.value['tid']];
                        if(Number(taxon.value['rankid']) > 180){
                            setTaxonSpecimenImages();
                        }
                        else{
                            processImages();
                        }
                    }
                });
            }

            function setTaxonSpecimenImages() {
                const formData = new FormData();
                formData.append('tidArr', JSON.stringify([taxon.value['tid']]));
                formData.append('limittooccurrence', '1');
                formData.append('limitPerTaxon', '100');
                formData.append('action', 'getTaxonArrDisplayImageData');
                fetch(imageApiUrl, {
                    method: 'POST',
                    body: formData
                })
                .then((response) => {
                    return response.ok ? response.json() : null;
                })
                .then((resObj) => {
                    if(resObj.hasOwnProperty(taxon.value['tid'])){
                        imageArr.value = imageArr.value.concat(resObj[taxon.value['tid']]);
                    }
                    processImages();
                });
            }

            function showFieldImageCarousel(index) {
                fieldImageCarouselSlide.value = index;
                fieldImageCarousel.value = true;
            }

            function showSpecimenImageCarousel(index) {
                specimenImageCarouselSlide.value = index;
                specimenImageCarousel.value = true;
            }

            function toggleFieldImageCarousel(val) {
                fieldImageCarousel.value = val;
            }

            function toggleSpecimenImageCarousel(val) {
                specimenImageCarousel.value = val;
            }

            function updateFieldImageCarousel(val) {
                fieldImageCarouselSlide.value = val;
            }

            function updateSpecimenImageCarousel(val) {
                specimenImageCarouselSlide.value = val;
            }

            Vue.onMounted(() => {
                showWorking('Loading...');
                setEditor();
                taxaStore.setTaxa(taxonValue, (tid) => {
                    hideWorking();
                    if(Number(tid) > 0){
                        taxaStore.setTaxaDescriptionData();
                        if(subtaxaArr.value.length > 0){
                            taxaStore.setSubtaxaImageData();
                        }
                        taxaStore.setTaxaImageArr();
                        if(Number(taxon.value['rankid']) > 180){
                            setTaxonFieldImages(100);
                        }
                        else{
                            setTaxonFieldImages(1);
                        }
                    }
                    else if(taxonValue.value && taxonValue.value !== ''){
                        taxaStore.setFuzzyMatches();
                    }
                    else{
                        window.location.href = clientRoot + '/index.php';
                    }
                });
            });

            return {
                centralImage,
                clientRoot,
                fieldImageArr,
                fieldImageCarousel,
                fieldImageCarouselSlide,
                imageCarousel,
                imageCarouselSlide,
                isTaxonEditor,
                isTaxonProfileEditor,
                specimenImageArr,
                specimenImageCarousel,
                specimenImageCarouselSlide,
                taxaImageArr,
                taxaImageCount,
                taxon,
                showFieldImageCarousel,
                showSpecimenImageCarousel,
                toggleFieldImageCarousel,
                toggleSpecimenImageCarousel,
                updateFieldImageCarousel,
                updateSpecimenImageCarousel
            }
        }
    });
    taxonProfilePage.use(Quasar, { config: {} });
    taxonProfilePage.use(Pinia.createPinia());
    taxonProfilePage.mount('#mainContainer');
</script>
