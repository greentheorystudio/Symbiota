<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa-description-block.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa-description-statement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa-map.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa-vernacular.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/stores/taxa.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/checkboxInputElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/dateInputElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/selectorInputElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/textFieldInputElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileEditButton.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileScinameHeader.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileNotFound.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonNotes.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonFamily.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonVernaculars.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonIdentifiers.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonSynonyms.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileCentralmage.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileDescriptionTabs.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonMap.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonImageLink.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileTaxonOccurrenceLink.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileImagePanel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileSubtaxaPanel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileMediaPanel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/input-elements/spatialBaseLayerSelector.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/spatial/spatialViewerElement.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/determinationRecordInfoBlock.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/geneticLinkRecordInfoBlock.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/media/imageCarousel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/media/imageRecordInfoBlock.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/media/mediaRecordInfoBlock.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/mofDataFieldRow.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/mofDataFieldRowGroup.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/occurrenceInfoTabModule.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/occurrences/occurrenceInfoWindowPopup.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/media/mediaInfoWindowPopup.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script src="<?php echo $GLOBALS['CLIENT_ROOT']; ?>/components/taxonomy/taxaProfileImageCarousel.js?ver=<?php echo $GLOBALS['JS_VERSION']; ?>" type="text/javascript"></script>
<script type="text/javascript">
    const taxonProfilePage = Vue.createApp({
        template: `
            <template v-if="Number(taxon['tid']) > 0">
                <div class="row justify-between q-mt-sm">
                    <div class="column">
                        <taxa-profile-sciname-header></taxa-profile-sciname-header>
                        <taxa-profile-taxon-family></taxa-profile-taxon-family>
                        <taxa-profile-taxon-notes></taxa-profile-taxon-notes>
                        <taxa-profile-taxon-vernaculars></taxa-profile-taxon-vernaculars>
                        <taxa-profile-taxon-synonyms></taxa-profile-taxon-synonyms>
                    </div>
                    <template v-if="isTaxonEditor || isTaxonProfileEditor">
                        <taxa-profile-edit-button :taxon-editor="isTaxonEditor" :taxon-profile-editor="isTaxonProfileEditor"></taxa-profile-edit-button>
                    </template>
                </div>
                <div class="row justify-between q-mt-sm">
                    <div class="left-column column">
                        <taxa-profile-central-image :is-editor="isTaxonProfileEditor" @update:set-image-carousel="showImageCarousel"></taxa-profile-central-image>
                    </div>
                    <div class="right-column column">
                        <taxa-profile-description-tabs></taxa-profile-description-tabs>
                        <div class="right-inner-row">
                            <taxa-profile-taxon-map></taxa-profile-taxon-map>
                        </div>
                        <template v-if="Number(taxaImageCount) > 100">
                            <div class="right-inner-row">
                                <taxa-profile-taxon-image-link></taxa-profile-taxon-image-link>
                            </div>
                        </template>
                        <div class="right-inner-row">
                            <taxa-profile-taxon-occurrence-link></taxa-profile-taxon-occurrence-link>
                        </div>
                    </div>
                </div>
                <div class="q-mt-md">
                    <taxa-profile-taxon-identifiers></taxa-profile-taxon-identifiers>
                </div>
                <div class="row justify-center q-mt-md">
                    <taxa-profile-image-panel @update:set-image-carousel="showImageCarousel"></taxa-profile-image-panel>
                </div>
                <div class="row justify-center q-mt-md">
                    <taxa-profile-media-panel></taxa-profile-media-panel>
                </div>
                <div class="row justify-center q-mt-md">
                    <taxa-profile-subtaxa-panel :is-editor="isTaxonProfileEditor"></taxa-profile-subtaxa-panel>
                </div>
            </template>
            <template v-else>
                <taxa-profile-not-found></taxa-profile-not-found>
            </template>
            <q-dialog v-model="imageCarousel" persistent full-width full-height>
                <taxa-profile-image-carousel :image-arr="taxaImageArr" :image-index="imageCarouselSlide" @update:show-image-carousel="toggleImageCarousel" @update:current-image="updateImageCarousel"></taxa-profile-image-carousel>
            </q-dialog>
        `,
        components: {
            'taxa-profile-edit-button': taxaProfileEditButton,
            'taxa-profile-sciname-header': taxaProfileScinameHeader,
            'taxa-profile-not-found': taxaProfileNotFound,
            'taxa-profile-taxon-notes': taxaProfileTaxonNotes,
            'taxa-profile-taxon-family': taxaProfileTaxonFamily,
            'taxa-profile-taxon-vernaculars': taxaProfileTaxonVernaculars,
            'taxa-profile-taxon-identifiers': taxaProfileTaxonIdentifiers,
            'taxa-profile-taxon-synonyms': taxaProfileTaxonSynonyms,
            'taxa-profile-central-image': taxaProfileCentralImage,
            'taxa-profile-description-tabs': taxaProfileDescriptionTabs,
            'taxa-profile-taxon-map': taxaProfileTaxonMap,
            'taxa-profile-taxon-image-link': taxaProfileTaxonImageLink,
            'taxa-profile-taxon-occurrence-link': taxaProfileTaxonOccurrenceLink,
            'taxa-profile-image-panel': taxaProfileImagePanel,
            'taxa-profile-subtaxa-panel': taxaProfileSubtaxaPanel,
            'taxa-profile-media-panel': taxaProfileMediaPanel,
            'taxa-profile-image-carousel': taxaProfileImageCarousel
        },
        setup() {
            const { hideWorking, showWorking } = useCore();
            const baseStore = useBaseStore();
            const taxaStore = useTaxaStore();

            const clientRoot = baseStore.getClientRoot;
            const imageCarousel = Vue.ref(false);
            const imageCarouselSlide = Vue.ref(null);
            const isTaxonEditor = Vue.ref(false);
            const isTaxonProfileEditor = Vue.ref(false);
            const subtaxaArr = Vue.computed(() => taxaStore.getTaxaChildren);
            const taxaImageArr = Vue.computed(() => taxaStore.getTaxaImageArr);
            const taxaImageCount = Vue.computed(() => taxaStore.getTaxaImageCount);
            const taxon = Vue.computed(() => taxaStore.getAcceptedTaxonData);
            const taxonValue = TAXON_VAL;

            function setEditor() {
                const formData = new FormData();
                formData.append('permissionJson', JSON.stringify(['TaxonProfile', 'Taxonomy']));
                formData.append('action', 'validatePermission');
                fetch(permissionApiUrl, {
                    method: 'POST',
                    body: formData
                })
                .then((response) => {
                    return response.ok ? response.json() : null;
                })
                .then((resData) => {
                    isTaxonEditor.value = resData.includes('Taxonomy');
                    isTaxonProfileEditor.value = resData.includes('TaxonProfile');
                });
            }

            function showImageCarousel(index) {
                imageCarouselSlide.value = index;
                imageCarousel.value = true;
            }

            function toggleImageCarousel(val) {
                imageCarousel.value = val;
            }

            function updateImageCarousel(val) {
                imageCarouselSlide.value = val;
            }

            Vue.onMounted(() => {
                showWorking('Loading...');
                setEditor();
                taxaStore.setTaxa(taxonValue, (tid) => {
                    hideWorking();
                    if(Number(tid) > 0){
                        taxaStore.setTaxaDescriptionData();
                        if(subtaxaArr.value.length > 0){
                            taxaStore.setSubtaxaImageData();
                        }
                        taxaStore.setTaxaImageArr();
                        taxaStore.setTaxaMediaArr();
                    }
                    else if(taxonValue.value && taxonValue.value !== ''){
                        taxaStore.setFuzzyMatches();
                    }
                    else{
                        window.location.href = clientRoot + '/index.php';
                    }
                });
            });

            return {
                imageCarousel,
                imageCarouselSlide,
                isTaxonEditor,
                isTaxonProfileEditor,
                taxaImageArr,
                taxaImageCount,
                taxon,
                showImageCarousel,
                toggleImageCarousel,
                updateImageCarousel
            }
        }
    });
    taxonProfilePage.use(Quasar, { config: {} });
    taxonProfilePage.use(Pinia.createPinia());
    taxonProfilePage.mount('#mainContainer');
</script>
